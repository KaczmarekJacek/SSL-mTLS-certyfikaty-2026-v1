# PKI i mTLS â€” Dokumentacja teoretyczna

> Kompletny przewodnik po infrastrukturze klucza publicznego, certyfikatach X.509 i wzajemnym uwierzytelnianiu TLS.

## Spis treÅ›ci

1. [Hierarchia PKI](#hierarchia-pki)
2. [Relacje miÄ™dzy certyfikatami](#relacje-miÄ™dzy-certyfikatami)
3. [ÅaÅ„cuch zaufania](#Å‚aÅ„cuch-zaufania)
4. [Keystore vs Truststore](#keystore-vs-truststore)
5. [Jak dziaÅ‚a mTLS](#jak-dziaÅ‚a-mtls)
6. [Struktura certyfikatu X.509](#struktura-certyfikatu-x509)
7. [Formaty plikÃ³w](#formaty-plikÃ³w)
8. [BezpieczeÅ„stwo i najlepsze praktyki](#bezpieczeÅ„stwo-i-najlepsze-praktyki)

---

## Hierarchia PKI

### Trzypoziomowa architektura

PKI (Public Key Infrastructure) to hierarchiczny system zarzÄ…dzania certyfikatami cyfrowymi. Nasza implementacja uÅ¼ywa klasycznej trzypoziomowej hierarchii:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ROOT CA                                         â”‚
â”‚                         (Self-signed)                                        â”‚
â”‚                                                                              â”‚
â”‚   Rola: KorzeÅ„ zaufania â€” najwyÅ¼szy poziom hierarchii                       â”‚
â”‚   WaÅ¼noÅ›Ä‡: 20 lat                                                            â”‚
â”‚   Przechowywanie: Offline / HSM (w produkcji)                               â”‚
â”‚   UÅ¼ycie: Tylko do podpisywania Intermediate CA                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â”‚ PODPISUJE
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          INTERMEDIATE CA                                     â”‚
â”‚                                                                              â”‚
â”‚   Rola: PoÅ›redni urzÄ…d certyfikacji                                         â”‚
â”‚   WaÅ¼noÅ›Ä‡: 10 lat                                                            â”‚
â”‚   Przechowywanie: Bezpieczny serwer / HSM                                   â”‚
â”‚   UÅ¼ycie: Podpisywanie certyfikatÃ³w koÅ„cowych (server, client)              â”‚
â”‚   Ograniczenie: pathlen:0 â€” moÅ¼e podpisywaÄ‡ TYLKO certyfikaty koÅ„cowe       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                      â”‚                      â”‚
           â”‚ PODPISUJE            â”‚ PODPISUJE            â”‚ PODPISUJE
           â–¼                      â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     SERVER       â”‚    â”‚    CLIENT A      â”‚    â”‚    CLIENT B      â”‚
â”‚                  â”‚    â”‚                  â”‚    â”‚                  â”‚
â”‚ Rola: ToÅ¼samoÅ›Ä‡  â”‚    â”‚ Rola: ToÅ¼samoÅ›Ä‡  â”‚    â”‚ Rola: ToÅ¼samoÅ›Ä‡  â”‚
â”‚       serwera    â”‚    â”‚       klienta    â”‚    â”‚       klienta    â”‚
â”‚ WaÅ¼noÅ›Ä‡: 1 rok   â”‚    â”‚ WaÅ¼noÅ›Ä‡: 1 rok   â”‚    â”‚ WaÅ¼noÅ›Ä‡: 1 rok   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Dlaczego trzy poziomy?

| Poziom | Uzasadnienie |
|--------|--------------|
| **Root CA** | Izolacja â€” klucz Root CA moÅ¼e byÄ‡ przechowywany offline (air-gapped), uÅ¼ywany tylko do podpisania Intermediate CA |
| **Intermediate CA** | OperacyjnoÅ›Ä‡ â€” kompromitacja Intermediate CA nie wymaga wymiany Root CA; moÅ¼na mieÄ‡ wiele Intermediate CA dla rÃ³Å¼nych Å›rodowisk |
| **End-entity** | KrÃ³tki cykl Å¼ycia â€” certyfikaty koÅ„cowe sÄ… wymieniane czÄ™sto (co rok), bez wpÅ‚ywu na infrastrukturÄ™ CA |

---

## Relacje miÄ™dzy certyfikatami

### WspÃ³lny "rodzic" â€” klucz do wzajemnego zaufania

W scenariuszu mTLS z jednym serwerem i wieloma klientami, **wszystkie certyfikaty sÄ… podpisane przez to samo Intermediate CA**:

```
                    INTERMEDIATE CA
                    (wspÃ³lny rodzic)
                          â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                 â”‚                 â”‚
        â–¼                 â–¼                 â–¼
    server.crt      service-a.crt    service-b.crt
        â”‚                 â”‚                 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                    RODZEÅƒSTWO
              (wzajemnie sobie ufajÄ…,
               bo majÄ… tego samego rodzica)
```

### Co to oznacza w praktyce?

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                              â”‚
â”‚   Serwer ma w TRUSTSTORE certyfikat Intermediate CA                         â”‚
â”‚                           â”‚                                                  â”‚
â”‚                           â–¼                                                  â”‚
â”‚   Service-A przychodzi z certyfikatem podpisanym przez Intermediate CA      â”‚
â”‚                           â”‚                                                  â”‚
â”‚                           â–¼                                                  â”‚
â”‚   Serwer: "Intermediate CA podpisaÅ‚ tego klienta,                           â”‚
â”‚            a ja ufam Intermediate CA â†’ wiÄ™c ufam temu klientowi"            â”‚
â”‚                                                                              â”‚
â”‚   To samo dziaÅ‚a w drugÄ… stronÄ™ â€” klient weryfikuje serwer.                 â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Matematyka podpisÃ³w cyfrowych

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     JAK DZIAÅA PODPIS CERTYFIKATU                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  1. Intermediate CA bierze dane certyfikatu klienta (CN, klucz publiczny,   â”‚
â”‚     daty waÅ¼noÅ›ci, rozszerzenia)                                            â”‚
â”‚                                                                              â”‚
â”‚  2. Oblicza hash tych danych (SHA-384)                                      â”‚
â”‚                                                                              â”‚
â”‚  3. Szyfruje hash KLUCZEM PRYWATNYM Intermediate CA                         â”‚
â”‚     â””â”€â”€ To jest PODPIS                                                       â”‚
â”‚                                                                              â”‚
â”‚  4. DoÅ‚Ä…cza podpis do certyfikatu                                           â”‚
â”‚                                                                              â”‚
â”‚  WERYFIKACJA:                                                                â”‚
â”‚                                                                              â”‚
â”‚  1. Serwer odczytuje podpis z certyfikatu klienta                           â”‚
â”‚                                                                              â”‚
â”‚  2. Deszyfruje podpis KLUCZEM PUBLICZNYM Intermediate CA                    â”‚
â”‚     â””â”€â”€ Klucz publiczny jest w certyfikacie Intermediate CA (w truststore)  â”‚
â”‚                                                                              â”‚
â”‚  3. Oblicza wÅ‚asny hash danych certyfikatu                                  â”‚
â”‚                                                                              â”‚
â”‚  4. PorÃ³wnuje: odszyfrowany hash == obliczony hash?                         â”‚
â”‚     â””â”€â”€ TAK = certyfikat jest autentyczny i niezmieniony                    â”‚
â”‚     â””â”€â”€ NIE = certyfikat jest sfaÅ‚szowany lub uszkodzony                    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ÅaÅ„cuch zaufania

### Chain of Trust â€” weryfikacja krok po kroku

Gdy serwer otrzymuje certyfikat klienta, musi zweryfikowaÄ‡ caÅ‚y Å‚aÅ„cuch:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    WERYFIKACJA CERTYFIKATU KLIENTA                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  KROK 1: SprawdÅº certyfikat klienta                                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                       â”‚
â”‚     client.crt                                                               â”‚
â”‚     â”‚                                                                        â”‚
â”‚     â””â”€â–º Issuer: "CN=Intermediate CA, O=MyCompany"                           â”‚
â”‚         â”‚                                                                    â”‚
â”‚         â””â”€â–º Szukam certyfikatu tego wystawcy...                             â”‚
â”‚                                                                              â”‚
â”‚  KROK 2: SprawdÅº certyfikat Intermediate CA                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                             â”‚
â”‚     intermediateCA.crt                                                       â”‚
â”‚     â”‚                                                                        â”‚
â”‚     â”œâ”€â–º Czy podpis na client.crt jest prawidÅ‚owy? âœ“                         â”‚
â”‚     â”‚                                                                        â”‚
â”‚     â””â”€â–º Issuer: "CN=Root CA, O=MyCompany"                                   â”‚
â”‚         â”‚                                                                    â”‚
â”‚         â””â”€â–º Szukam certyfikatu tego wystawcy...                             â”‚
â”‚                                                                              â”‚
â”‚  KROK 3: SprawdÅº certyfikat Root CA                                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                       â”‚
â”‚     rootCA.crt                                                               â”‚
â”‚     â”‚                                                                        â”‚
â”‚     â”œâ”€â–º Czy podpis na intermediateCA.crt jest prawidÅ‚owy? âœ“                 â”‚
â”‚     â”‚                                                                        â”‚
â”‚     â””â”€â–º Issuer: "CN=Root CA" (self-signed)                                  â”‚
â”‚         â”‚                                                                    â”‚
â”‚         â””â”€â–º Czy Root CA jest w moim TRUSTSTORE? âœ“                           â”‚
â”‚                                                                              â”‚
â”‚  WYNIK: CaÅ‚y Å‚aÅ„cuch zweryfikowany â€” certyfikat klienta jest zaufany        â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Plik ca-chain.crt

Aby uproÅ›ciÄ‡ weryfikacjÄ™, tworzymy plik `ca-chain.crt` zawierajÄ…cy caÅ‚y Å‚aÅ„cuch CA:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ca-chain.crt                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ -----BEGIN CERTIFICATE-----                                          â”‚   â”‚
â”‚   â”‚ [Intermediate CA Certificate]                                        â”‚   â”‚
â”‚   â”‚ -----END CERTIFICATE-----                                            â”‚   â”‚
â”‚   â”‚                                                                      â”‚   â”‚
â”‚   â”‚ -----BEGIN CERTIFICATE-----                                          â”‚   â”‚
â”‚   â”‚ [Root CA Certificate]                                                â”‚   â”‚
â”‚   â”‚ -----END CERTIFICATE-----                                            â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚   KolejnoÅ›Ä‡: od najbliÅ¼szego do Root CA                                     â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Keystore vs Truststore

### Fundamentalna rÃ³Å¼nica

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                              â”‚
â”‚   KEYSTORE  = "Kim JA jestem"      (moja toÅ¼samoÅ›Ä‡)                         â”‚
â”‚                                                                              â”‚
â”‚   TRUSTSTORE = "Komu JA ufam"      (lista zaufanych)                        â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Keystore â€” moja toÅ¼samoÅ›Ä‡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              KEYSTORE                                        â”‚
â”‚                        (np. server-keystore.p12)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   Zawiera:                                                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚                                                                    â”‚     â”‚
â”‚   â”‚   ğŸ”‘ KLUCZ PRYWATNY (tajny!)                                      â”‚     â”‚
â”‚   â”‚      â””â”€â”€ uÅ¼ywany do:                                              â”‚     â”‚
â”‚   â”‚          â€¢ podpisywania danych (dowÃ³d toÅ¼samoÅ›ci)                 â”‚     â”‚
â”‚   â”‚          â€¢ deszyfrowania danych zaszyfrowanych kluczem publicznym â”‚     â”‚
â”‚   â”‚                                                                    â”‚     â”‚
â”‚   â”‚   ğŸ“œ CERTYFIKAT (publiczny)                                       â”‚     â”‚
â”‚   â”‚      â””â”€â”€ "dowÃ³d osobisty" wysyÅ‚any drugiej stronie                â”‚     â”‚
â”‚   â”‚      â””â”€â”€ zawiera klucz publiczny                                  â”‚     â”‚
â”‚   â”‚                                                                    â”‚     â”‚
â”‚   â”‚   ğŸ“œ ÅAÅƒCUCH CA (publiczny)                                       â”‚     â”‚
â”‚   â”‚      â””â”€â”€ intermediate + root (dowÃ³d, kto mnie "wydaÅ‚")            â”‚     â”‚
â”‚   â”‚                                                                    â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                              â”‚
â”‚   ğŸ”´ POUFNOÅšÄ†: WYSOKA â€” zawiera klucz prywatny!                             â”‚
â”‚                                                                              â”‚
â”‚   Analogia: DOWÃ“D OSOBISTY + KLUCZ DO DOMU                                  â”‚
â”‚   â€¢ DowÃ³d pokazujesz innym (certyfikat)                                     â”‚
â”‚   â€¢ Klucz do domu trzymasz tylko dla siebie (klucz prywatny)                â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Truststore â€” komu ufam

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                             TRUSTSTORE                                       â”‚
â”‚                          (truststore.p12)                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   Zawiera:                                                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚                                                                    â”‚     â”‚
â”‚   â”‚   ğŸ“œ CERTYFIKATY CA (tylko publiczne!)                            â”‚     â”‚
â”‚   â”‚      â”œâ”€â”€ Root CA certificate                                      â”‚     â”‚
â”‚   â”‚      â””â”€â”€ Intermediate CA certificate                              â”‚     â”‚
â”‚   â”‚                                                                    â”‚     â”‚
â”‚   â”‚   âŒ BEZ KLUCZY PRYWATNYCH                                        â”‚     â”‚
â”‚   â”‚                                                                    â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                              â”‚
â”‚   ğŸŸ¢ POUFNOÅšÄ†: NISKA â€” zawiera tylko publiczne certyfikaty                  â”‚
â”‚                                                                              â”‚
â”‚   Analogia: LISTA ZAUFANYCH URZÄ˜DÃ“W                                         â”‚
â”‚   â€¢ "Ufam dokumentom wystawionym przez UrzÄ…d Stanu Cywilnego"               â”‚
â”‚   â€¢ "Ufam dokumentom wystawionym przez ten konkretny CA"                    â”‚
â”‚   â€¢ Nie potrzebujesz ich kluczy prywatnych â€” tylko wiesz, Å¼e im ufasz       â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### PorÃ³wnanie

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         â”‚       KEYSTORE          â”‚      TRUSTSTORE         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Zawiera                 â”‚ Klucz prywatny +        â”‚ Tylko certyfikaty       â”‚
â”‚                         â”‚ certyfikat + Å‚aÅ„cuch CA â”‚ CA (publiczne)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Odpowiada na pytanie    â”‚ "Kim jestem?"           â”‚ "Komu ufam?"            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ UÅ¼ywany do              â”‚ Przedstawienia siÄ™      â”‚ Weryfikacji             â”‚
â”‚                         â”‚ drugiej stronie         â”‚ drugiej strony          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PoufnoÅ›Ä‡                â”‚ ğŸ”´ TAJNY                â”‚ ğŸŸ¢ MoÅ¼e byÄ‡ publiczny   â”‚
â”‚                         â”‚ (zawiera klucz pryw.)   â”‚ (tylko certyfikaty)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ UnikalnoÅ›Ä‡              â”‚ KaÅ¼da aplikacja         â”‚ MoÅ¼e byÄ‡ wspÃ³Å‚dzielony  â”‚
â”‚                         â”‚ ma wÅ‚asny               â”‚ (ten sam dla wszystkich)â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ W naszym projekcie      â”‚ server-keystore.p12     â”‚ truststore.p12          â”‚
â”‚                         â”‚ client-X-keystore.p12   â”‚ (jeden dla wszystkich)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Jak wspÃ³Å‚pracujÄ… w poÅ‚Ä…czeniu mTLS

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            SERWER                â”‚         â”‚            KLIENT                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                  â”‚         â”‚                                  â”‚
â”‚  KEYSTORE (server-keystore.p12)  â”‚         â”‚  KEYSTORE (client-keystore.p12)  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ”‘ server.key              â”‚  â”‚         â”‚  â”‚ ğŸ”‘ client.key              â”‚  â”‚
â”‚  â”‚ ğŸ“œ server.crt  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  â”‚ ğŸ“œ client.crt  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”€â”€â”
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  (1)    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚                                  â”‚         â”‚                                  â”‚    â”‚
â”‚  TRUSTSTORE (truststore.p12)     â”‚         â”‚  TRUSTSTORE (truststore.p12)     â”‚    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚ ğŸ“œ CA chain â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”‚ ğŸ“œ CA chain                â”‚  â”‚    â”‚
â”‚  â”‚    (weryfikuje klientÃ³w)   â”‚  â”‚  (2)    â”‚  â”‚    (weryfikuje serwer) â—„â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”€â”€â”˜
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                  â”‚         â”‚                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

(1) Serwer wysyÅ‚a swÃ³j certyfikat â†’ Klient weryfikuje przez SWÃ“J truststore
(2) Klient wysyÅ‚a swÃ³j certyfikat â†’ Serwer weryfikuje przez SWÃ“J truststore
```

---

## Jak dziaÅ‚a mTLS

### TLS vs mTLS

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              TLS (jednokierunkowy)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   Klient â—„â”€â”€â”€â”€â”€â”€â”€ Serwer przedstawia certyfikat â”€â”€â”€â”€â”€â”€â”€ Serwer              â”‚
â”‚                                                                              â”‚
â”‚   â€¢ Klient weryfikuje toÅ¼samoÅ›Ä‡ serwera                                     â”‚
â”‚   â€¢ Serwer NIE weryfikuje toÅ¼samoÅ›ci klienta                                â”‚
â”‚   â€¢ Typowe uÅ¼ycie: HTTPS do stron WWW                                       â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              mTLS (dwukierunkowy)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   Klient â—„â”€â”€â”€â”€â”€â”€â”€ Serwer przedstawia certyfikat â”€â”€â”€â”€â”€â”€â”€ Serwer              â”‚
â”‚   Klient â”€â”€â”€â”€â”€â”€â”€ Klient przedstawia certyfikat â”€â”€â”€â”€â”€â”€â”€â–º Serwer              â”‚
â”‚                                                                              â”‚
â”‚   â€¢ Klient weryfikuje toÅ¼samoÅ›Ä‡ serwera                                     â”‚
â”‚   â€¢ Serwer weryfikuje toÅ¼samoÅ›Ä‡ klienta                                     â”‚
â”‚   â€¢ Typowe uÅ¼ycie: Komunikacja miÄ™dzy mikroserwisami, API                   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Przebieg handshake mTLS

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CLIENT  â”‚                                          â”‚  SERVER  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                                                     â”‚
     â”‚  1. ClientHello                                     â”‚
     â”‚     - Supported TLS versions (1.2, 1.3)             â”‚
     â”‚     - Supported cipher suites                       â”‚
     â”‚     - Random bytes                                  â”‚
     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚
     â”‚                                                     â”‚
     â”‚  2. ServerHello                                     â”‚
     â”‚     - Selected TLS version (1.3)                    â”‚
     â”‚     - Selected cipher suite                         â”‚
     â”‚     - Random bytes                                  â”‚
     â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
     â”‚                                                     â”‚
     â”‚  3. Server Certificate                              â”‚
     â”‚     - server.crt                                    â”‚
     â”‚     - intermediateCA.crt (Å‚aÅ„cuch)                  â”‚
     â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
     â”‚                                                     â”‚
     â”‚  4. CertificateRequest (to wÅ‚Ä…cza mTLS!)            â”‚
     â”‚     - "WyÅ›lij mi swÃ³j certyfikat"                   â”‚
     â”‚     - Lista akceptowanych CA                        â”‚
     â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
     â”‚                                                     â”‚
     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
     â”‚  â”‚ KLIENT WERYFIKUJE SERWER:                    â”‚   â”‚
     â”‚  â”‚ â€¢ Czy server.crt podpisany przez znane CA?  â”‚   â”‚
     â”‚  â”‚ â€¢ Czy certyfikat nie wygasÅ‚?                â”‚   â”‚
     â”‚  â”‚ â€¢ Czy CN/SAN pasuje do hostname?            â”‚   â”‚
     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
     â”‚                                                     â”‚
     â”‚  5. Client Certificate (mTLS)                       â”‚
     â”‚     - client.crt                                    â”‚
     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚
     â”‚                                                     â”‚
     â”‚  6. CertificateVerify (mTLS)                        â”‚
     â”‚     - Podpis kluczem prywatnym klienta             â”‚
     â”‚     - DowÃ³d posiadania klucza prywatnego           â”‚
     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚
     â”‚                                                     â”‚
     â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                    â”‚ SERWER WERYFIKUJE KLIENTA:                  â”‚
     â”‚                    â”‚ â€¢ Czy client.crt podpisany przez znane CA?  â”‚
     â”‚                    â”‚ â€¢ Czy certyfikat nie wygasÅ‚?                â”‚
     â”‚                    â”‚ â€¢ Czy podpis CertificateVerify jest OK?     â”‚
     â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                                     â”‚
     â”‚  7. Key Exchange (ECDHE)                            â”‚
     â”‚     - Uzgodnienie kluczy sesyjnych                  â”‚
     â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
     â”‚                                                     â”‚
     â”‚  8. Finished (encrypted)                            â”‚
     â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
     â”‚                                                     â”‚
     â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
     â”‚         SZYFROWANA KOMUNIKACJA APLIKACYJNA          â”‚
     â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
```

### PrzepÅ‚yw weryfikacji

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    KLIENT ÅÄ„CZY SIÄ˜ Z SERWEREM                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  KROK 1: Serwer przedstawia siÄ™                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                          â”‚
â”‚                                                                              â”‚
â”‚    Serwer â”€â”€â–º "Oto mÃ³j certyfikat (z MOJEGO keystore)"                      â”‚
â”‚                                                                              â”‚
â”‚    Klient â”€â”€â–º Sprawdza w SWOIM truststore:                                  â”‚
â”‚               "Czy znam CA, ktÃ³ry podpisaÅ‚ ten certyfikat?"                 â”‚
â”‚               âœ“ Tak â†’ OK, ufam serwerowi                                    â”‚
â”‚               âœ— Nie â†’ ODRZUCAM poÅ‚Ä…czenie                                   â”‚
â”‚                                                                              â”‚
â”‚  KROK 2: Klient przedstawia siÄ™ (mTLS)                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                       â”‚
â”‚                                                                              â”‚
â”‚    Klient â”€â”€â–º "Oto mÃ³j certyfikat (z MOJEGO keystore)"                      â”‚
â”‚                                                                              â”‚
â”‚    Serwer â”€â”€â–º Sprawdza w SWOIM truststore:                                  â”‚
â”‚               "Czy znam CA, ktÃ³ry podpisaÅ‚ ten certyfikat?"                 â”‚
â”‚               âœ“ Tak â†’ OK, ufam klientowi                                    â”‚
â”‚               âœ— Nie â†’ ODRZUCAM poÅ‚Ä…czenie                                   â”‚
â”‚                                                                              â”‚
â”‚  KROK 3: Szyfrowana komunikacja                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                          â”‚
â”‚                                                                              â”‚
â”‚    Obie strony uÅ¼ywajÄ… uzgodnionych KLUCZY SESYJNYCH                        â”‚
â”‚    do szyfrowania/deszyfrowania danych                                      â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Struktura certyfikatu X.509

### GÅ‚Ã³wne pola certyfikatu

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CERTYFIKAT X.509 v3                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Version:             3 (0x2)                                               â”‚
â”‚  Serial Number:       1000 (unikalny numer)                                 â”‚
â”‚                                                                              â”‚
â”‚  Signature Algorithm: sha384WithRSAEncryption                               â”‚
â”‚                                                                              â”‚
â”‚  Issuer:              CN=Intermediate CA, O=MyCompany, C=PL                 â”‚
â”‚                       (kto wystawiÅ‚ certyfikat)                             â”‚
â”‚                                                                              â”‚
â”‚  Validity:                                                                   â”‚
â”‚      Not Before:      Jan  1 00:00:00 2025 GMT                              â”‚
â”‚      Not After:       Jan  1 00:00:00 2026 GMT                              â”‚
â”‚                                                                              â”‚
â”‚  Subject:             CN=localhost, O=MyCompany, C=PL                       â”‚
â”‚                       (dla kogo jest certyfikat)                            â”‚
â”‚                                                                              â”‚
â”‚  Subject Public Key:  RSA 4096 bit                                          â”‚
â”‚                       (klucz publiczny wÅ‚aÅ›ciciela)                         â”‚
â”‚                                                                              â”‚
â”‚  X509v3 Extensions:                                                          â”‚
â”‚      Basic Constraints: CA:FALSE                                            â”‚
â”‚      Key Usage: Digital Signature, Key Encipherment                         â”‚
â”‚      Extended Key Usage: TLS Web Server Authentication                      â”‚
â”‚      Subject Alternative Name:                                              â”‚
â”‚          DNS:localhost                                                      â”‚
â”‚          DNS:*.localhost                                                    â”‚
â”‚          IP:127.0.0.1                                                       â”‚
â”‚                                                                              â”‚
â”‚  Signature:           [podpis Intermediate CA]                              â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Rozszerzenia X.509 â€” rÃ³Å¼nice miÄ™dzy typami certyfikatÃ³w

#### Root CA

```
X509v3 Basic Constraints: critical
    CA:TRUE
X509v3 Key Usage: critical
    Certificate Sign, CRL Sign
```

#### Intermediate CA

```
X509v3 Basic Constraints: critical
    CA:TRUE, pathlen:0
X509v3 Key Usage: critical
    Certificate Sign, CRL Sign
```

#### Server Certificate

```
X509v3 Basic Constraints:
    CA:FALSE
X509v3 Key Usage: critical
    Digital Signature, Key Encipherment
X509v3 Extended Key Usage:
    TLS Web Server Authentication
X509v3 Subject Alternative Name:
    DNS:localhost, IP:127.0.0.1
```

#### Client Certificate

```
X509v3 Basic Constraints:
    CA:FALSE
X509v3 Key Usage: critical
    Digital Signature, Key Encipherment, Non Repudiation
X509v3 Extended Key Usage:
    TLS Web Client Authentication
```

### Subject Alternative Name (SAN)

SAN okreÅ›la dla jakich hostÃ³w/IP certyfikat jest waÅ¼ny:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SUBJECT ALTERNATIVE NAME                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   DNS:localhost                     â† dokÅ‚adne dopasowanie                  â”‚
â”‚   DNS:*.localhost                   â† wildcard dla subdomen                 â”‚
â”‚   DNS:*.default.svc.cluster.local   â† Kubernetes services                   â”‚
â”‚   IP:127.0.0.1                      â† adres IP                              â”‚
â”‚   IP:10.0.0.1                       â† wewnÄ™trzny IP                         â”‚
â”‚                                                                              â”‚
â”‚   Klient sprawdza czy hostname/IP do ktÃ³rego siÄ™ Å‚Ä…czy                      â”‚
â”‚   pasuje do ktÃ³regoÅ› z wpisÃ³w SAN.                                          â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Formaty plikÃ³w

### PorÃ³wnanie formatÃ³w

| Format | Rozszerzenie | Kodowanie | ZawartoÅ›Ä‡ | UÅ¼ycie |
|--------|--------------|-----------|-----------|--------|
| **PEM** | `.pem`, `.crt`, `.key` | Base64 (tekst) | Certyfikaty, klucze | Uniwersalne, Linux |
| **DER** | `.der`, `.cer` | Binary | Certyfikaty | Windows, Java (stare) |
| **PKCS12** | `.p12`, `.pfx` | Binary | Cert + klucz + Å‚aÅ„cuch | Java, Windows |
| **JKS** | `.jks` | Binary | Cert + klucz | Java (przestarzaÅ‚e) |

### Format PEM

```
-----BEGIN CERTIFICATE-----
MIIFazCCA1OgAwIBAgIUZ3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3Z3UwDQYJKoZIhvcNAQEL
BQAwRTELMAkGA1UEBhMCUEwxEzARBgNVBAgMCk1hem93aWVja2llMSEwHwYDVQQK
... (Base64 encoded data) ...
-----END CERTIFICATE-----
```

### Format PKCS12 (preferowany dla Java)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           PKCS12 (.p12)                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   â€¢ Format binarny (nie tekstowy)                                           â”‚
â”‚   â€¢ Chroniony hasÅ‚em                                                         â”‚
â”‚   â€¢ Zawiera wszystko w jednym pliku:                                        â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  ğŸ”‘ Private Key                                                      â”‚   â”‚
â”‚   â”‚  ğŸ“œ Certificate                                                      â”‚   â”‚
â”‚   â”‚  ğŸ“œ CA Chain (opcjonalnie)                                          â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚   Zalety:                                                                    â”‚
â”‚   â€¢ Jedno hasÅ‚o do caÅ‚ego pliku                                             â”‚
â”‚   â€¢ Åatwa dystrybucja (jeden plik zamiast wielu)                            â”‚
â”‚   â€¢ Natywne wsparcie w Java KeyStore API                                    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Dlaczego PKCS12 zamiast JKS?

| Aspekt | JKS | PKCS12 |
|--------|-----|--------|
| Standard | WÅ‚asnoÅ›ciowy (Sun/Oracle) | Otwarty (RFC 7292) |
| InteroperacyjnoÅ›Ä‡ | Tylko Java | Java, .NET, OpenSSL, przeglÄ…darki |
| Szyfrowanie | SÅ‚absze (PBEWithMD5AndTripleDES) | Silniejsze (AES-256) |
| Status | Deprecated od Java 9 | Zalecany |

---

## BezpieczeÅ„stwo i najlepsze praktyki

### Ochrona kluczy prywatnych

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    POZIOMY OCHRONY KLUCZY PRYWATNYCH                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  ğŸ”´ ROOT CA KEY â€” NAJWYÅ»SZA OCHRONA                                         â”‚
â”‚     â€¢ Przechowywanie offline (air-gapped)                                   â”‚
â”‚     â€¢ HSM (Hardware Security Module) w produkcji                            â”‚
â”‚     â€¢ DostÄ™p tylko dla wyznaczonych osÃ³b                                    â”‚
â”‚     â€¢ UÅ¼ycie: tylko do podpisania Intermediate CA (raz na 10 lat)           â”‚
â”‚                                                                              â”‚
â”‚  ğŸŸ  INTERMEDIATE CA KEY â€” WYSOKA OCHRONA                                    â”‚
â”‚     â€¢ Bezpieczny serwer z ograniczonym dostÄ™pem                             â”‚
â”‚     â€¢ HSM zalecany w produkcji                                              â”‚
â”‚     â€¢ Audit logging wszystkich operacji                                     â”‚
â”‚     â€¢ UÅ¼ycie: podpisywanie certyfikatÃ³w koÅ„cowych                           â”‚
â”‚                                                                              â”‚
â”‚  ğŸŸ¡ SERVER/CLIENT KEYS â€” STANDARDOWA OCHRONA                                â”‚
â”‚     â€¢ Szyfrowanie hasÅ‚em (PKCS12)                                           â”‚
â”‚     â€¢ Uprawnienia plikÃ³w: 400 (tylko wÅ‚aÅ›ciciel)                            â”‚
â”‚     â€¢ Secrets management (Vault, K8s Secrets)                               â”‚
â”‚     â€¢ Rotacja: co rok                                                       â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### WaÅ¼noÅ›Ä‡ certyfikatÃ³w â€” zalecenia

| Typ certyfikatu | Åšrodowisko Dev | Åšrodowisko Prod |
|-----------------|----------------|-----------------|
| Root CA | 20 lat | 20 lat |
| Intermediate CA | 10 lat | 10 lat |
| Server/Client | 1 rok | 90 dni |

### Checklist bezpieczeÅ„stwa

```
â–¡ Klucze prywatne CA nigdy nie opuszczajÄ… bezpiecznego Å›rodowiska
â–¡ HasÅ‚a do keystores sÄ… unikalne i silne (nie "changeit" w produkcji!)
â–¡ Certyfikaty majÄ… odpowiednie rozszerzenia (CA:FALSE dla end-entity)
â–¡ SAN zawiera wszystkie wymagane hosty/IP
â–¡ Rotacja certyfikatÃ³w przed wygaÅ›niÄ™ciem
â–¡ Monitoring dat wygaÅ›niÄ™cia
â–¡ Backup kluczy CA (zaszyfrowany, offline)
â–¡ Procedura revokacji (CRL/OCSP) dla kompromitacji
```

### Typowe bÅ‚Ä™dy

| BÅ‚Ä…d | Konsekwencja | RozwiÄ…zanie |
|------|--------------|-------------|
| Ten sam klucz dla wielu certyfikatÃ³w | Kompromitacja jednego = kompromitacja wszystkich | Unikalny klucz dla kaÅ¼dego certyfikatu |
| Brak SAN | BÅ‚Ä™dy weryfikacji hostname | Zawsze dodawaj SAN |
| Za dÅ‚uga waÅ¼noÅ›Ä‡ cert. koÅ„cowych | WiÄ™ksze okno ataku | Max 1 rok (90 dni w produkcji) |
| Hardcoded hasÅ‚a | Wyciek credentials | Secrets management |
| Brak pathlen w Intermediate CA | MoÅ¼liwoÅ›Ä‡ tworzenia nieautoryzowanych CA | Zawsze `pathlen:0` |

---

## Analogie do Å›wiata realnego

### Hierarchia PKI = System dokumentÃ³w

```
                         URZÄ„D STANU CYWILNEGO
                            (Root CA)
                                â”‚
                    wydaje akty urodzenia
                                â”‚
                                â–¼
                         SZPITAL MIEJSKI
                         (Intermediate CA)
                                â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                 â”‚                 â”‚
              â–¼                 â–¼                 â–¼
          Jan Kowalski     Anna Nowak       Piotr WiÅ›niewski
          (server)         (client-a)       (client-b)
          
KaÅ¼dy z nich ma "akt urodzenia" (certyfikat) wystawiony przez
ten sam szpital, wiÄ™c mogÄ… siÄ™ wzajemnie zweryfikowaÄ‡ sprawdzajÄ…c,
czy ich dokumenty pochodzÄ… z tego samego, zaufanego ÅºrÃ³dÅ‚a.
```

### Keystore i Truststore = Dokumenty osobiste

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                              â”‚
â”‚   KEYSTORE = TwÃ³j portfel                                                   â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                  â”‚
â”‚   â€¢ DowÃ³d osobisty (certyfikat) â€” pokazujesz innym                          â”‚
â”‚   â€¢ Klucz do domu (klucz prywatny) â€” trzymasz dla siebie                    â”‚
â”‚                                                                              â”‚
â”‚   TRUSTSTORE = Lista zaufanych instytucji                                   â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                     â”‚
â”‚   â€¢ "Ufam dokumentom z UrzÄ™du Stanu Cywilnego"                              â”‚
â”‚   â€¢ "Ufam dokumentom z Ambasady RP"                                         â”‚
â”‚   â€¢ Nie masz ich kluczy â€” tylko wiesz, Å¼e im ufasz                          â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Podsumowanie

### Kluczowe koncepcje

1. **PKI** to hierarchiczny system zaufania: Root CA â†’ Intermediate CA â†’ End-entity
2. **Keystore** zawiera twojÄ… toÅ¼samoÅ›Ä‡ (klucz prywatny + certyfikat)
3. **Truststore** zawiera listÄ™ CA, ktÃ³rym ufasz
4. **mTLS** wymaga wzajemnej weryfikacji â€” obie strony przedstawiajÄ… certyfikaty
5. **ÅaÅ„cuch zaufania** weryfikowany jest od certyfikatu koÅ„cowego do Root CA
6. **PKCS12** jest preferowanym formatem dla aplikacji Java

### PrzepÅ‚yw zaufania w mTLS

```
Serwer przedstawia certyfikat â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Klient przedstawia certyfikat
        â”‚                                                            â”‚
        â–¼                                                            â–¼
Klient weryfikuje przez                                   Serwer weryfikuje przez
    SWÃ“J truststore                                           SWÃ“J truststore
        â”‚                                                            â”‚
        â–¼                                                            â–¼
"Czy znam CA ktÃ³ry                                       "Czy znam CA ktÃ³ry
 podpisaÅ‚ serwer?"                                        podpisaÅ‚ klienta?"
        â”‚                                                            â”‚
        â–¼                                                            â–¼
      âœ“ TAK                                                        âœ“ TAK
        â”‚                                                            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ZAUFANE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                        SZYFROWANA KOMUNIKACJA
```
